<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ã†ã•ãã®æ°—æŒã¡ARğŸ°</title>

  <!-- ã¾ã‚‹ã„æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆ -->
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500&display=swap" rel="stylesheet">

  <style>
    :root {
      --card-bg: rgba(255,255,255,0.9);
      --card-shadow: 0 20px 40px rgba(255,150,200,0.4);
      --text-main: #2b2b2b;
      --text-sub: #444;
      --accent: #ff6fa8;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at 50% 20%, #fff 0%, #f6f3ff 60%, #e6e8ff 100%);
      font-family: "Zen Maru Gothic", system-ui, sans-serif;
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
    }

    .stage {
      position: relative;
      width: 90%;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    video {
      width: 100%;
      border-radius: 20px;
      background: #000;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      object-fit: cover;
    }

    /* å¹ãå‡ºã—ã‚«ãƒ¼ãƒ‰ */
    .bubble {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0.5rem;

      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: var(--card-shadow);

      padding: 14px 18px 12px;
      min-width: 80%;
      max-width: 90%;

      text-align: center;
      line-height: 1.4;
      animation: float 3s ease-in-out infinite;
    }

    .mood-line {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--accent);
      text-shadow: 0 0 8px rgba(255,111,168,0.4);
      display: flex;
      flex-direction: column;
      align-items: center;
      word-break: keep-all;
    }

    .mood-main {
      font-size: 1.3rem;
    }

    .mood-sub {
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-top: 6px;
    }

    @keyframes float {
      0%,100% { transform: translate(-50%,0); }
      50%     { transform: translate(-50%,-4px); }
    }

    /* å°ã•ã„ç«¯æœ«ã§èª­ã¿ã‚„ã™ã */
    @media (max-width: 360px){
      .mood-main { font-size:1.1rem; }
      .mood-sub  { font-size:0.7rem; }
    }
  </style>

  <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆå®‰å®šç‰ˆã®çµ„ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.8.6"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
</head>

<body>
  <div class="stage">
    <video id="webcam" autoplay playsinline muted></video>

    <div class="bubble" id="bubble">
      <div class="mood-line">
        <div class="mood-main" id="moodMain">ï¼Ÿï¼Ÿã„ã¾èª¿ã¹ã¦ã‚‹â€¦</div>
      </div>
      <div class="mood-sub" id="moodSub">
        AIãŒè€ƒãˆä¸­ã ã‚ˆï¼ˆä¿¡é ¼åº¦ â€• %ï¼‰
      </div>
    </div>
  </div>

  <script>
    // â† ã‚ãªãŸã®Teachable Machineãƒ¢ãƒ‡ãƒ«
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/ggc7-ON3j/";

    const video   = document.getElementById("webcam");
    const moodMain = document.getElementById("moodMain");
    const moodSub  = document.getElementById("moodSub");

    let model;

    // ãƒ©ãƒ™ãƒ«å â†’ ã‹ã‚ã„ã„è¡¨ç¤ºã«å¤‰æ›ã™ã‚‹é–¢æ•°
    function prettyMood(labelName, prob) {
      const pStr = (prob * 100).toFixed(1);

      // å°æ–‡å­—æ¯”è¼ƒç”¨
      const lower = labelName.toLowerCase();

      // ã“ã“ã«ã€Œã‚ãªãŸã®ã‚¯ãƒ©ã‚¹åã€ã‚’å…¨éƒ¨ã‚«ãƒãƒ¼ã™ã‚‹
      // Teachable Machineå´ã®ã‚¯ãƒ©ã‚¹åãŒ
      // Relax / Curious / Alert / Grooming
      // ã¿ãŸã„ãªè‹±èªãªã‚‰ã“ã£ã¡ã§ãƒãƒƒãƒã•ã›ã‚‹
      if (lower.includes("relax")) {
        return {
          main: "ğŸ’¤ ã„ã¾å®‰å¿ƒã—ã¦ã‚‹ã‚ˆ",
          sub:  `ã¨ã£ã¦ã‚‚ãŠã ã‚„ã‹ã€œï¼ˆä¿¡é ¼åº¦ ${pStr}%ï¼‰`
        };
      }

      if (lower.includes("curious")) {
        return {
          main: "ğŸ°â“ ãã‚‡ã†ã¿ã—ã‚“ã—ã‚“ï¼",
          sub:  `ã¾ã‚ã‚Šã‚’è¦³å¯Ÿä¸­ï¼ˆä¿¡é ¼åº¦ ${pStr}%ï¼‰`
        };
      }

      if (lower.includes("alert")) {
        return {
          main: "âš¡ ã¡ã‚‡ã£ã¨è­¦æˆ’ã—ã¦ã‚‹ã‹ã‚‚",
          sub:  `å‘¨å›²ã‚’ãƒã‚§ãƒƒã‚¯ä¸­ï¼ˆä¿¡é ¼åº¦ ${pStr}%ï¼‰`
        };
      }

      if (lower.includes("groom")) {
        return {
          main: "ğŸ«§ æ¯›ã¥ãã‚ã„ã‚¿ã‚¤ãƒ ",
          sub:  `ãŠæ‰‹å…¥ã‚Œã—ã¦ã‚‹ã¨ã“ã‚ï¼ˆä¿¡é ¼åº¦ ${pStr}%ï¼‰`
        };
      }

      // æ—¥æœ¬èªãƒ©ãƒ™ãƒ«ã‚‚ä¸€å¿œã‚«ãƒãƒ¼
      if (lower.includes("ãƒªãƒ©ãƒƒã‚¯ã‚¹")) {
        return {
          main: "ğŸ’¤ ã„ã¾å®‰å¿ƒã—ã¦ã‚‹ã‚ˆ",
          sub:  `ãŠã ã‚„ã‹ãƒ¢ãƒ¼ãƒ‰ï¼ˆä¿¡é ¼åº¦ ${pStr}%ï¼‰`
        };
      }
      if (lower.includes("è­¦æˆ’")) {
        return {
          main: "âš¡ ã¡ã‚‡ã£ã¨è­¦æˆ’ã—ã¦ã‚‹ã‹ã‚‚",
          sub:  `å‘¨å›²ã¿ã¦ã‚‹ï¼ˆä¿¡é ¼åº¦ ${pStr}%ï¼‰`
        };
      }
      if (lower.includes("å¥½å¥‡") || lower.includes("ãã‚‡ã†ã¿") ) {
        return {
          main: "ğŸ°â“ ãã‚‡ã†ã¿ã—ã‚“ã—ã‚“ï¼",
          sub:  `æ–°ã—ã„ã‚‚ã®ãƒã‚§ãƒƒã‚¯ä¸­ï¼ˆä¿¡é ¼åº¦ ${pStr}%ï¼‰`
        };
      }
      if (lower.includes("æ¯›ã¥ãã‚ã„") || lower.includes("æ¯›ç¹•ã„") ) {
        return {
          main: "ğŸ«§ æ¯›ã¥ãã‚ã„ã‚¿ã‚¤ãƒ ",
          sub:  `ãã‚Œã„ãã‚Œã„ä¸­ï¼ˆä¿¡é ¼åº¦ ${pStr}%ï¼‰`
        };
      }

      // fallbackï¼ˆçŸ¥ã‚‰ãªã„ãƒ©ãƒ™ãƒ«ï¼‰
      return {
        main: `ğŸ‡ ${labelName}ã‹ãªï¼Ÿ`,
        sub:  `AIã®æ¨å®šä¸­ï¼ˆä¿¡é ¼åº¦ ${pStr}%ï¼‰`
      };
    }

    async function init() {
      try {
        model = await tmImage.load(
          MODEL_URL + "model.json",
          MODEL_URL + "metadata.json"
        );

        // ã‚«ãƒ¡ãƒ©èµ·å‹•
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          loop();
        };

      } catch (err) {
        moodMain.textContent = "âš  ãƒ¢ãƒ‡ãƒ«ã‹ã‚«ãƒ¡ãƒ©ã«å•é¡ŒãŒã‚ã‚‹ã‹ã‚‚";
        moodSub.textContent  = err.message || "èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
      }
    }

    async function loop() {
      // videoãŒæº–å‚™ã§ãã¦ã¦ãƒ¢ãƒ‡ãƒ«ã‚‚ã‚ã‚‹ãªã‚‰æ¨è«–
      if (model && video.readyState === 4) {
        try {
          const preds = await model.predict(video);

          if (preds && preds.length > 0) {
            // ä¸€ç•ªé«˜ã„ã‚¯ãƒ©ã‚¹
            let best = preds[0];
            for (let i = 1; i < preds.length; i++) {
              if (preds[i].probability > best.probability) {
                best = preds[i];
              }
            }

            // ã‹ã‚ã„ã„æ–‡ç« ã«å¤‰æ›ã—ã¦è¡¨ç¤º
            const moodText = prettyMood(best.className, best.probability);
            moodMain.textContent = moodText.main;
            moodSub.textContent  = moodText.sub;
          } else {
            moodMain.textContent = "ğŸ‡ ã†ã¾ãè¦‹ãˆãªã„ã‹ã‚‚";
            moodSub.textContent  = "ã‚«ãƒ¡ãƒ©ã‚’è¿‘ã¥ã‘ã¦ã­";
          }

        } catch (err) {
          moodMain.textContent = "ğŸ’¦ æ¨å®šã§ããªã‹ã£ãŸ";
          moodSub.textContent  = err.message || "error";
        }
      }

      requestAnimationFrame(loop);
    }

    init();
  </script>
</body>
</html>
