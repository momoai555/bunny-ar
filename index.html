<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>うさぎの気持ちAR🐰</title>

  <!-- まるい日本語フォント -->
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500&display=swap" rel="stylesheet">

  <style>
    :root {
      --card-bg: rgba(255,255,255,0.9);
      --card-shadow: 0 20px 40px rgba(255,150,200,0.4);
      --text-main: #2b2b2b;
      --text-sub: #444;
      --accent: #ff6fa8;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at 50% 20%, #fff 0%, #f6f3ff 60%, #e6e8ff 100%);
      font-family: "Zen Maru Gothic", system-ui, sans-serif;
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
    }

    .stage {
      position: relative;
      width: 90%;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    video {
      width: 100%;
      border-radius: 20px;
      background: #000;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      object-fit: cover;
    }

    /* 吹き出しカード */
    .bubble {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0.5rem;

      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: var(--card-shadow);

      padding: 14px 18px 12px;
      min-width: 80%;
      max-width: 90%;

      text-align: center;
      line-height: 1.4;
      animation: float 3s ease-in-out infinite;
    }

    .mood-line {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--accent);
      text-shadow: 0 0 8px rgba(255,111,168,0.4);
      display: flex;
      flex-direction: column;
      align-items: center;
      word-break: keep-all;
    }

    .mood-main {
      font-size: 1.3rem;
    }

    .mood-sub {
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-top: 6px;
    }

    @keyframes float {
      0%,100% { transform: translate(-50%,0); }
      50%     { transform: translate(-50%,-4px); }
    }

    /* 小さい端末で読みやすく */
    @media (max-width: 360px){
      .mood-main { font-size:1.1rem; }
      .mood-sub  { font-size:0.7rem; }
    }
  </style>

  <!-- ライブラリ（安定版の組） -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.8.6"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
</head>

<body>
  <div class="stage">
    <video id="webcam" autoplay playsinline muted></video>

    <div class="bubble" id="bubble">
      <div class="mood-line">
        <div class="mood-main" id="moodMain">？？いま調べてる…</div>
      </div>
      <div class="mood-sub" id="moodSub">
        AIが考え中だよ（信頼度 ― %）
      </div>
    </div>
  </div>

  <script>
    // ← あなたのTeachable Machineモデル
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/ggc7-ON3j/";

    const video   = document.getElementById("webcam");
    const moodMain = document.getElementById("moodMain");
    const moodSub  = document.getElementById("moodSub");

    let model;

    // ラベル名 → かわいい表示に変換する関数
    function prettyMood(labelName, prob) {
      const pStr = (prob * 100).toFixed(1);

      // 小文字比較用
      const lower = labelName.toLowerCase();

      // ここに「あなたのクラス名」を全部カバーする
      // Teachable Machine側のクラス名が
      // Relax / Curious / Alert / Grooming
      // みたいな英語ならこっちでマッチさせる
      if (lower.includes("relax")) {
        return {
          main: "💤 いま安心してるよ",
          sub:  `とってもおだやか〜（信頼度 ${pStr}%）`
        };
      }

      if (lower.includes("curious")) {
        return {
          main: "🐰❓ きょうみしんしん！",
          sub:  `まわりを観察中（信頼度 ${pStr}%）`
        };
      }

      if (lower.includes("alert")) {
        return {
          main: "⚡ ちょっと警戒してるかも",
          sub:  `周囲をチェック中（信頼度 ${pStr}%）`
        };
      }

      if (lower.includes("groom")) {
        return {
          main: "🫧 毛づくろいタイム",
          sub:  `お手入れしてるところ（信頼度 ${pStr}%）`
        };
      }

      // 日本語ラベルも一応カバー
      if (lower.includes("リラックス")) {
        return {
          main: "💤 いま安心してるよ",
          sub:  `おだやかモード（信頼度 ${pStr}%）`
        };
      }
      if (lower.includes("警戒")) {
        return {
          main: "⚡ ちょっと警戒してるかも",
          sub:  `周囲みてる（信頼度 ${pStr}%）`
        };
      }
      if (lower.includes("好奇") || lower.includes("きょうみ") ) {
        return {
          main: "🐰❓ きょうみしんしん！",
          sub:  `新しいものチェック中（信頼度 ${pStr}%）`
        };
      }
      if (lower.includes("毛づくろい") || lower.includes("毛繕い") ) {
        return {
          main: "🫧 毛づくろいタイム",
          sub:  `きれいきれい中（信頼度 ${pStr}%）`
        };
      }

      // fallback（知らないラベル）
      return {
        main: `🐇 ${labelName}かな？`,
        sub:  `AIの推定中（信頼度 ${pStr}%）`
      };
    }

    async function init() {
      try {
        model = await tmImage.load(
          MODEL_URL + "model.json",
          MODEL_URL + "metadata.json"
        );

        // カメラ起動
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          loop();
        };

      } catch (err) {
        moodMain.textContent = "⚠ モデルかカメラに問題があるかも";
        moodSub.textContent  = err.message || "読み込みエラー";
      }
    }

    async function loop() {
      // videoが準備できててモデルもあるなら推論
      if (model && video.readyState === 4) {
        try {
          const preds = await model.predict(video);

          if (preds && preds.length > 0) {
            // 一番高いクラス
            let best = preds[0];
            for (let i = 1; i < preds.length; i++) {
              if (preds[i].probability > best.probability) {
                best = preds[i];
              }
            }

            // かわいい文章に変換して表示
            const moodText = prettyMood(best.className, best.probability);
            moodMain.textContent = moodText.main;
            moodSub.textContent  = moodText.sub;
          } else {
            moodMain.textContent = "🐇 うまく見えないかも";
            moodSub.textContent  = "カメラを近づけてね";
          }

        } catch (err) {
          moodMain.textContent = "💦 推定できなかった";
          moodSub.textContent  = err.message || "error";
        }
      }

      requestAnimationFrame(loop);
    }

    init();
  </script>
</body>
</html>
