<script>
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/-NL3fIAqm/";

const videoEl = document.getElementById("webcam");
const bubbleMain = document.getElementById("bubbleMain");
const bubbleSub  = document.getElementById("bubbleSub");

let model;
let recentResults = [];

// 小さいキャンバスを作って、映像のざっくり情報を見る用
const senseCanvas = document.createElement("canvas");
senseCanvas.width = 64;
senseCanvas.height = 64;
const senseCtx = senseCanvas.getContext("2d");

// 感情メッセージ
function moodMessage(label, percentStr) {
  const lower = label.toLowerCase();

  if (lower.includes("relax")) {
    return { main: "💤 おだやかモード", sub: "安心してのんびり中（信頼度 " + percentStr + "）" };
  }
  if (lower.includes("curious")) {
    return { main: "🐰❓ きょうみしんしん！", sub: "新しいものをチェックしてるよ（信頼度 " + percentStr + "）" };
  }
  if (lower.includes("alert")) {
    return { main: "⚡ ピーン！警戒中", sub: "音や動きをじっと見てる（信頼度 " + percentStr + "）" };
  }
  if (lower.includes("groom")) {
    return { main: "✨ きれいきれいタイム", sub: "毛づくろいしてるよ（信頼度 " + percentStr + "）" };
  }
  if (lower.includes("happy")) {
    return { main: "💗 はしゃぎモード！", sub: "ぴょんぴょん跳ねてごきげん（信頼度 " + percentStr + "）" };
  }
  if (lower.includes("angry")) {
    return { main: "💢 足ダン発動！？", sub: "ちょっとイラッとしてるかも（信頼度 " + percentStr + "）" };
  }
  return { main: "🐇 " + label, sub: "AIの推定だよ（信頼度 " + percentStr + "）" };
}

// 映像に「それっぽいものが映ってるか」チェックする関数
function looksLikeSomethingIsThere() {
  // いまのフレームを小さくコピー
  senseCtx.drawImage(videoEl, 0, 0, senseCanvas.width, senseCanvas.height);
  const imgData = senseCtx.getImageData(0, 0, senseCanvas.width, senseCanvas.height).data;

  // 明るさの平均と分散っぽいものを見る
  let sum = 0;
  let sumSq = 0;
  const totalPixels = senseCanvas.width * senseCanvas.height;

  for (let i = 0; i < imgData.length; i += 4) {
    // 明るさ（R,G,Bの平均）
    const r = imgData[i];
    const g = imgData[i+1];
    const b = imgData[i+2];
    const brightness = (r + g + b) / 3;
    sum += brightness;
    sumSq += brightness * brightness;
  }

  const mean = sum / totalPixels;
  const variance = (sumSq / totalPixels) - (mean * mean);
  const stddev = Math.sqrt(Math.max(variance, 0));

  // 条件：
  // - 画面がほぼ真っ暗（mean がめっちゃ低い）
  // - 画面がほぼ真っ白（mean がめっちゃ高い）
  // - ほとんど同じ色だけ（stddev が小さすぎ）
  //
  // こういうときは「何もいない/ちゃんと映ってない」扱いにする
  if (mean < 15) {        // ほぼ真っ暗
    return false;
  }
  if (mean > 240) {       // ほぼ真っ白
    return false;
  }
  if (stddev < 5) {       // ほぼ同じ色だけ（=床しか映ってない、壁だけ等）
    return false;
  }

  // それっぽい何かは映ってる
  return true;
}

async function init() {
  try {
    model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
  } catch (e) {
    bubbleMain.textContent = "💦 モデル読めなかった…";
    bubbleSub.textContent  = "あとでもういちど開いてみてね";
    return;
  }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });
    videoEl.srcObject = stream;
    videoEl.onloadedmetadata = () => {
      videoEl.play();
      loop();
    };
  } catch (e) {
    bubbleMain.textContent = "📱 カメラ許可してね";
    bubbleSub.textContent  = "カメラがないと読めないんだ…";
    return;
  }
}

async function loop() {
  if (model && videoEl.readyState === 4) {
    try {
      // まず「そもそも何か映ってる？」チェック
      const hasBunnyLikeContent = looksLikeSomethingIsThere();

      const predictions = await model.predict(videoEl);

      if (predictions && predictions.length > 0) {
        // 一番確率高いクラスを見つける
        let best = predictions[0];
        for (let i = 1; i < predictions.length; i++) {
          if (predictions[i].probability > best.probability) {
            best = predictions[i];
          }
        }

        // 「何もいないっぽい」または「確信度が低い」場合は解析中にする
        if (!hasBunnyLikeContent || best.probability < 0.5) {
          bubbleMain.textContent = "🐇 解析中…";
          bubbleSub.textContent  =
            "AIが考え中だよ（信頼度 " +
            (best.probability * 100).toFixed(1) +
            "%）";
          requestAnimationFrame(loop);
          return;
        }

        // 安定化のために最近10回のラベルを取って多数決
        recentResults.push(best.className);
        if (recentResults.length > 10) recentResults.shift();

        const majority = recentResults
          .sort((a,b) =>
            recentResults.filter(v=>v===a).length -
            recentResults.filter(v=>v===b).length
          )
          .pop();

        const percentStr = (best.probability * 100).toFixed(1) + "%";
        const msg = moodMessage(majority, percentStr);

        bubbleMain.textContent = msg.main;
        bubbleSub.textContent  = msg.sub;
      }
    } catch (err) {
      bubbleMain.textContent = "⚠ 推定エラー";
      bubbleSub.textContent  = err.message;
    }
  }

  requestAnimationFrame(loop);
}

init();
</script>
