<script>
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/-NL3fIAqm/";

const videoEl = document.getElementById("webcam");
const bubbleMain = document.getElementById("bubbleMain");
const bubbleSub  = document.getElementById("bubbleSub");

let model;
let recentResults = [];

// å°ã•ã„ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œã£ã¦ã€æ˜ åƒã®ã–ã£ãã‚Šæƒ…å ±ã‚’è¦‹ã‚‹ç”¨
const senseCanvas = document.createElement("canvas");
senseCanvas.width = 64;
senseCanvas.height = 64;
const senseCtx = senseCanvas.getContext("2d");

// æ„Ÿæƒ…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function moodMessage(label, percentStr) {
  const lower = label.toLowerCase();

  if (lower.includes("relax")) {
    return { main: "ğŸ’¤ ãŠã ã‚„ã‹ãƒ¢ãƒ¼ãƒ‰", sub: "å®‰å¿ƒã—ã¦ã®ã‚“ã³ã‚Šä¸­ï¼ˆä¿¡é ¼åº¦ " + percentStr + "ï¼‰" };
  }
  if (lower.includes("curious")) {
    return { main: "ğŸ°â“ ãã‚‡ã†ã¿ã—ã‚“ã—ã‚“ï¼", sub: "æ–°ã—ã„ã‚‚ã®ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚‹ã‚ˆï¼ˆä¿¡é ¼åº¦ " + percentStr + "ï¼‰" };
  }
  if (lower.includes("alert")) {
    return { main: "âš¡ ãƒ”ãƒ¼ãƒ³ï¼è­¦æˆ’ä¸­", sub: "éŸ³ã‚„å‹•ãã‚’ã˜ã£ã¨è¦‹ã¦ã‚‹ï¼ˆä¿¡é ¼åº¦ " + percentStr + "ï¼‰" };
  }
  if (lower.includes("groom")) {
    return { main: "âœ¨ ãã‚Œã„ãã‚Œã„ã‚¿ã‚¤ãƒ ", sub: "æ¯›ã¥ãã‚ã„ã—ã¦ã‚‹ã‚ˆï¼ˆä¿¡é ¼åº¦ " + percentStr + "ï¼‰" };
  }
  if (lower.includes("happy")) {
    return { main: "ğŸ’— ã¯ã—ã‚ƒããƒ¢ãƒ¼ãƒ‰ï¼", sub: "ã´ã‚‡ã‚“ã´ã‚‡ã‚“è·³ã­ã¦ã”ãã’ã‚“ï¼ˆä¿¡é ¼åº¦ " + percentStr + "ï¼‰" };
  }
  if (lower.includes("angry")) {
    return { main: "ğŸ’¢ è¶³ãƒ€ãƒ³ç™ºå‹•ï¼ï¼Ÿ", sub: "ã¡ã‚‡ã£ã¨ã‚¤ãƒ©ãƒƒã¨ã—ã¦ã‚‹ã‹ã‚‚ï¼ˆä¿¡é ¼åº¦ " + percentStr + "ï¼‰" };
  }
  return { main: "ğŸ‡ " + label, sub: "AIã®æ¨å®šã ã‚ˆï¼ˆä¿¡é ¼åº¦ " + percentStr + "ï¼‰" };
}

// æ˜ åƒã«ã€Œãã‚Œã£ã½ã„ã‚‚ã®ãŒæ˜ ã£ã¦ã‚‹ã‹ã€ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
function looksLikeSomethingIsThere() {
  // ã„ã¾ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å°ã•ãã‚³ãƒ”ãƒ¼
  senseCtx.drawImage(videoEl, 0, 0, senseCanvas.width, senseCanvas.height);
  const imgData = senseCtx.getImageData(0, 0, senseCanvas.width, senseCanvas.height).data;

  // æ˜ã‚‹ã•ã®å¹³å‡ã¨åˆ†æ•£ã£ã½ã„ã‚‚ã®ã‚’è¦‹ã‚‹
  let sum = 0;
  let sumSq = 0;
  const totalPixels = senseCanvas.width * senseCanvas.height;

  for (let i = 0; i < imgData.length; i += 4) {
    // æ˜ã‚‹ã•ï¼ˆR,G,Bã®å¹³å‡ï¼‰
    const r = imgData[i];
    const g = imgData[i+1];
    const b = imgData[i+2];
    const brightness = (r + g + b) / 3;
    sum += brightness;
    sumSq += brightness * brightness;
  }

  const mean = sum / totalPixels;
  const variance = (sumSq / totalPixels) - (mean * mean);
  const stddev = Math.sqrt(Math.max(variance, 0));

  // æ¡ä»¶ï¼š
  // - ç”»é¢ãŒã»ã¼çœŸã£æš—ï¼ˆmean ãŒã‚ã£ã¡ã‚ƒä½ã„ï¼‰
  // - ç”»é¢ãŒã»ã¼çœŸã£ç™½ï¼ˆmean ãŒã‚ã£ã¡ã‚ƒé«˜ã„ï¼‰
  // - ã»ã¨ã‚“ã©åŒã˜è‰²ã ã‘ï¼ˆstddev ãŒå°ã•ã™ãï¼‰
  //
  // ã“ã†ã„ã†ã¨ãã¯ã€Œä½•ã‚‚ã„ãªã„/ã¡ã‚ƒã‚“ã¨æ˜ ã£ã¦ãªã„ã€æ‰±ã„ã«ã™ã‚‹
  if (mean < 15) {        // ã»ã¼çœŸã£æš—
    return false;
  }
  if (mean > 240) {       // ã»ã¼çœŸã£ç™½
    return false;
  }
  if (stddev < 5) {       // ã»ã¼åŒã˜è‰²ã ã‘ï¼ˆ=åºŠã—ã‹æ˜ ã£ã¦ãªã„ã€å£ã ã‘ç­‰ï¼‰
    return false;
  }

  // ãã‚Œã£ã½ã„ä½•ã‹ã¯æ˜ ã£ã¦ã‚‹
  return true;
}

async function init() {
  try {
    model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
  } catch (e) {
    bubbleMain.textContent = "ğŸ’¦ ãƒ¢ãƒ‡ãƒ«èª­ã‚ãªã‹ã£ãŸâ€¦";
    bubbleSub.textContent  = "ã‚ã¨ã§ã‚‚ã†ã„ã¡ã©é–‹ã„ã¦ã¿ã¦ã­";
    return;
  }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });
    videoEl.srcObject = stream;
    videoEl.onloadedmetadata = () => {
      videoEl.play();
      loop();
    };
  } catch (e) {
    bubbleMain.textContent = "ğŸ“± ã‚«ãƒ¡ãƒ©è¨±å¯ã—ã¦ã­";
    bubbleSub.textContent  = "ã‚«ãƒ¡ãƒ©ãŒãªã„ã¨èª­ã‚ãªã„ã‚“ã â€¦";
    return;
  }
}

async function loop() {
  if (model && videoEl.readyState === 4) {
    try {
      // ã¾ãšã€Œãã‚‚ãã‚‚ä½•ã‹æ˜ ã£ã¦ã‚‹ï¼Ÿã€ãƒã‚§ãƒƒã‚¯
      const hasBunnyLikeContent = looksLikeSomethingIsThere();

      const predictions = await model.predict(videoEl);

      if (predictions && predictions.length > 0) {
        // ä¸€ç•ªç¢ºç‡é«˜ã„ã‚¯ãƒ©ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹
        let best = predictions[0];
        for (let i = 1; i < predictions.length; i++) {
          if (predictions[i].probability > best.probability) {
            best = predictions[i];
          }
        }

        // ã€Œä½•ã‚‚ã„ãªã„ã£ã½ã„ã€ã¾ãŸã¯ã€Œç¢ºä¿¡åº¦ãŒä½ã„ã€å ´åˆã¯è§£æä¸­ã«ã™ã‚‹
        if (!hasBunnyLikeContent || best.probability < 0.5) {
          bubbleMain.textContent = "ğŸ‡ è§£æä¸­â€¦";
          bubbleSub.textContent  =
            "AIãŒè€ƒãˆä¸­ã ã‚ˆï¼ˆä¿¡é ¼åº¦ " +
            (best.probability * 100).toFixed(1) +
            "%ï¼‰";
          requestAnimationFrame(loop);
          return;
        }

        // å®‰å®šåŒ–ã®ãŸã‚ã«æœ€è¿‘10å›ã®ãƒ©ãƒ™ãƒ«ã‚’å–ã£ã¦å¤šæ•°æ±º
        recentResults.push(best.className);
        if (recentResults.length > 10) recentResults.shift();

        const majority = recentResults
          .sort((a,b) =>
            recentResults.filter(v=>v===a).length -
            recentResults.filter(v=>v===b).length
          )
          .pop();

        const percentStr = (best.probability * 100).toFixed(1) + "%";
        const msg = moodMessage(majority, percentStr);

        bubbleMain.textContent = msg.main;
        bubbleSub.textContent  = msg.sub;
      }
    } catch (err) {
      bubbleMain.textContent = "âš  æ¨å®šã‚¨ãƒ©ãƒ¼";
      bubbleSub.textContent  = err.message;
    }
  }

  requestAnimationFrame(loop);
}

init();
</script>
